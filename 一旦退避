#define LGFX_AUTODETECT
#include <LovyanGFX.hpp>

class LGFX : public lgfx::LGFX_Device
{
  lgfx::Panel_ILI9341 _panel_instance;
  lgfx::Bus_SPI _bus_instance; // SPIバスのインスタンス
public:
  LGFX(void)
  {
    {                                    // バス制御の設定を行います。
      auto cfg = _bus_instance.config(); // バス設定用の構造体を取得します。

      // SPIバスの設定
      cfg.spi_host = SPI2_HOST;
      cfg.spi_mode = 0;          // SPI通信モードを設定 (0 ~ 3)
      cfg.freq_write = 8000000; // 送信時のSPIクロック (最大80MHz, 80MHzを整数で割った値に丸められます)
      cfg.freq_read =  8000000;  // 受信時のSPIクロック

      //      cfg.spi_3wire  = true;        // 受信をMOSIピンで行う場合はtrueを設定
      //      cfg.use_lock   = true;        // トランザクションロックを使用する場合はtrueを設定
      cfg.dma_channel = SPI_DMA_CH_AUTO; // 使用するDMAチャンネルを設定 (0=DMA不使用 / 1=1ch / 2=ch / SPI_DMA_CH_AUTO=自動設定)
      cfg.pin_sclk = 6//TFT_SCLK; // SPIのSCLKピン番号を設定
      cfg.pin_mosi = 7//TFT_MOSI; // SPIのMOSIピン番号を設定
      cfg.pin_miso = 5//TFT_MISO; // SPIのMISOピン番号を設定 (-1 = disable)
      cfg.pin_dc = 9//TFT_DC;     // SPIのD/Cピン番号を設定  (-1 = disable)

      _bus_instance.config(cfg);              // 設定値をバスに反映します。
      _panel_instance.setBus(&_bus_instance); // バスをパネルにセットします。
    }

    {                                      // 表示パネル制御の設定を行います。
      auto cfg = _panel_instance.config(); // 表示パネル設定用の構造体を取得します。

      cfg.pin_cs = 8//TFT_CS;   // CSが接続されているピン番号   (-1 = disable)
      cfg.pin_rst = 4//TFT_RST; // RSTが接続されているピン番号  (-1 = disable)
      cfg.pin_busy = -1;     // BUSYが接続されているピン番号 (-1 = disable)

      // cfg.panel_width = 240;  // 実際に表示可能な幅
      // cfg.panel_height = 320; // 実際に表示可能な高さ
      // cfg.offset_x = 0;       // パネルのX方向オフセット量
      // cfg.offset_y = 0;       // パネルのY方向オフセット量
      // cfg.invert = true;      // パネルの明暗が反転してしまう場合 trueに設定

      _panel_instance.config(cfg);
    }
    setPanel(&_panel_instance); // 使用するパネルをセットします。
  }
};


static LGFX lcd;

void setup(void)
{
  Serial.begin(115200);

  lcd.init();                   // 最初に初期化関数を呼び出します。
  lcd.setRotation(0);           // 回転方向を 0～3 の4方向から設定します。
                                // (4～7を使用すると上下反転になります。)
  lcd.setBrightness(128);       // バックライトの輝度を 0～255 の範囲で設定します。
  lcd.setColorDepth(24);        // RGB888の24ビットに設定
  lcd.fillScreen(TFT_DARKGRAY); // 画面全体の塗り潰し
}

void loop(void)
{
  uint16_t tX, tY;
  bool touched = lcd.getTouch(&tX, &tY);
  if( touched ) {
    Serial.println("touched (" + String(tX) + "," + String(tY) + ")");
    lcd.setColor(TFT_YELLOW);
    lcd.drawCircle (tX, tY, 20);
  }
}